---
title: "New Tasks"
author: "Martin Freisehner & Wilma Weixelbaum"
date: "June 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
load('WCBC.RData')

# checks
stopifnot(team.info %>% distinct(Year, Team) %>% group_by(Year) %>% summarize(n =n()) %>% filter(n != 32) %>% summarize(n=n()) == 0)

library(DT)
```

* **Task 17** Choose a (first) model for a predictor. Clearly state your modelling assumptions and any decisions you made also during the foramting of the data, e.g. 

    - use only results after 90 minutes.
    - use only data after 1994
    - which identifier was used to merge the data sets.

Since the data availability varies between data sets, clearly state how you want to fit and evaluate your predictor. The availability of the selected data sets is as follows:

    - Historic WC data is available since the 1930s
    - FIFA ranks are available since 1993, 
    - the full player's data is available for the 2018 world cup only,
    - the market value of a player is available since 2006.

For other sources of data the availability might be different. Thus, we need a good strategy for bulding a classifier and evaluating it.

If you want to use information such as scored goals, caps, etc. for every player, then the only possiblity would be the qualifiers. Where can be obtain the results?
```{r }
# create MW stats
getMwStats <- function() {

  gk_positions <- c('Torwart')
  def_positions <- c('Innenverteidiger', 'Linker Verteidiger', 'Rechter Verteidiger', 'Abwehr', 'Libero')
  mid_positions <- c('Defensives Mittelfeld', 'Zentrales Mittelfeld', 'Offensives Mittelfeld', 'Linkes Mittelfeld', 'Rechtes Mittelfeld', 'Mittelfeld')
  atk_positions <- c('Linksaußen', 'Rechtsaußen', 'Mittelstürmer', 'Hängende Spitze', 'Sturm')

  #add position group
  team.info <- team.info %>%
    mutate(Position.Grp = ifelse(Position %in% gk_positions, "GK",
                          ifelse(Position %in% def_positions, "DEF",
                          ifelse(Position %in% mid_positions, "MID",
                          ifelse(Position %in% atk_positions, "ATK", "NA")))))
  # add mw rank
  team.info <- team.info %>% 
    group_by(Year) %>%
    mutate(Market.Value.Rank = rank(desc(Market.Value), ties.method="min"))
  
  # add mw position rank
  team.info <- team.info %>%
    group_by(Year, Position.Grp) %>%
    mutate(Market.Value.GroupRank = rank(desc(Market.Value), ties.method="min"))

  #no info for 2002
  team.info[team.info$Year==2002,]$Market.Value.Rank <- NaN
  team.info[team.info$Year==2002,]$Market.Value.GroupRank <- NaN
  
  num_features <- 11
  
  top_23 <- team.info %>% 
    group_by(Year, Team) %>%
    arrange(desc(Market.Value)) %>%
    slice(1:23) %>%
    summarize(sum_mv = sum(Market.Value, na.rm=TRUE),
              avg_mv = mean(Market.Value, na.rm=TRUE),
              avg_mv_rank = mean(Market.Value.Rank, na.rm=TRUE),
              avg_mv_grp_rank = mean(Market.Value.GroupRank, na.rm=TRUE),
              avg_age = mean(Age, na.rm=TRUE),
              avg_height = mean(Height, na.rm=TRUE),
              avg_caps = mean(Caps, na.rm=TRUE),
              avg_goals = mean(Goals, na.rm=TRUE),
              avg_goal_rate = mean(Goals, na.rm=TRUE)/mean(Caps, na.rm=TRUE))
  colnames(top_23)[3:num_features] <- paste("top_23_", colnames(top_23)[3:num_features], sep="")
  
  top_11 <- team.info %>% 
    group_by(Year, Team) %>%
    arrange(desc(Market.Value)) %>%
    slice(1:11) %>%
    summarize(sum_mv = sum(Market.Value, na.rm=TRUE),
              avg_mv = mean(Market.Value, na.rm=TRUE),
              avg_mv_rank = mean(Market.Value.Rank, na.rm=TRUE),
              avg_mv_grp_rank = mean(Market.Value.GroupRank, na.rm=TRUE),
              avg_age = mean(Age, na.rm=TRUE),
              avg_height = mean(Height, na.rm=TRUE),
              avg_caps = mean(Caps, na.rm=TRUE),
              avg_goals = mean(Goals, na.rm=TRUE),
              avg_goal_rate = mean(Goals, na.rm=TRUE)/mean(Caps, na.rm=TRUE))
  colnames(top_11)[3:num_features] <- paste("top_11_", colnames(top_11)[3:num_features], sep="")
  
  top_5_def <- team.info %>%
    filter(Position.Grp == "DEF") %>%
    group_by(Year, Team) %>%
    arrange(desc(Market.Value)) %>%
    slice(1:5) %>%
    summarize(sum_mv = sum(Market.Value, na.rm=TRUE),
              avg_mv = mean(Market.Value, na.rm=TRUE),
              avg_mv_rank = mean(Market.Value.Rank, na.rm=TRUE),
              avg_mv_grp_rank = mean(Market.Value.GroupRank, na.rm=TRUE),
              avg_age = mean(Age, na.rm=TRUE),
              avg_height = mean(Height, na.rm=TRUE),
              avg_caps = mean(Caps, na.rm=TRUE),
              avg_goals = mean(Goals, na.rm=TRUE),
              avg_goal_rate = mean(Goals, na.rm=TRUE)/mean(Caps, na.rm=TRUE))
  colnames(top_5_def)[3:num_features] <- paste("top_5_def_", colnames(top_5_def)[3:num_features], sep="")
    
  top_5_mid <- team.info %>%
    filter(Position.Grp == "MID") %>%
    group_by(Year, Team) %>%
    arrange(desc(Market.Value)) %>%
    slice(1:5) %>%
    summarize(sum_mv = sum(Market.Value, na.rm=TRUE),
              avg_mv = mean(Market.Value, na.rm=TRUE),
              avg_mv_rank = mean(Market.Value.Rank, na.rm=TRUE),
              avg_mv_grp_rank = mean(Market.Value.GroupRank, na.rm=TRUE),
              avg_age = mean(Age, na.rm=TRUE),
              avg_height = mean(Height, na.rm=TRUE),
              avg_caps = mean(Caps, na.rm=TRUE),
              avg_goals = mean(Goals, na.rm=TRUE),
              avg_goal_rate = mean(Goals, na.rm=TRUE)/mean(Caps, na.rm=TRUE))
  colnames(top_5_mid)[3:num_features] <- paste("top_5_mid_", colnames(top_5_mid)[3:num_features], sep="")
    
    top_5_att <- team.info %>%
    filter(Position.Grp == "ATK") %>%
    group_by(Year, Team) %>%
    arrange(desc(Market.Value)) %>%
    slice(1:5) %>%
    summarize(sum_mv = sum(Market.Value, na.rm=TRUE),
              avg_mv = mean(Market.Value, na.rm=TRUE),
              avg_mv_rank = mean(Market.Value.Rank, na.rm=TRUE),
              avg_mv_grp_rank = mean(Market.Value.GroupRank, na.rm=TRUE),
              avg_age = mean(Age, na.rm=TRUE),
              avg_height = mean(Height, na.rm=TRUE),
              avg_caps = mean(Caps, na.rm=TRUE),
              avg_goals = mean(Goals, na.rm=TRUE),
              avg_goal_rate = mean(Goals, na.rm=TRUE)/mean(Caps, na.rm=TRUE))
    colnames(top_5_att)[3:num_features] <- paste("top_5_att_", colnames(top_5_att)[3:num_features], sep="")
    
    top_gk <- team.info %>%
    filter(Position.Grp == "GK") %>%
    group_by(Year, Team) %>%
    arrange(desc(Market.Value)) %>%
    slice(1:1) %>%
    summarize(sum_mv = sum(Market.Value, na.rm=TRUE),
              avg_mv = mean(Market.Value, na.rm=TRUE),
              avg_mv_rank = mean(Market.Value.Rank, na.rm=TRUE),
              avg_mv_grp_rank = mean(Market.Value.GroupRank, na.rm=TRUE),
              avg_age = mean(Age, na.rm=TRUE),
              avg_height = mean(Height, na.rm=TRUE),
              avg_caps = mean(Caps, na.rm=TRUE),
              avg_goals = mean(Goals, na.rm=TRUE),
              avg_goal_rate = mean(Goals, na.rm=TRUE)/mean(Caps, na.rm=TRUE))
    colnames(top_gk)[3:num_features] <- paste("top_gk_", colnames(top_gk)[3:num_features], sep="")
    
    key_players <- team.info %>%
      group_by(Year, Team) %>%
      summarize(top_3 = sum(Market.Value.GroupRank < 4, na.rm=TRUE),
                top_5 = sum(Market.Value.GroupRank < 6, na.rm=TRUE),
                top_10 = sum(Market.Value.GroupRank < 11, na.rm=TRUE),
                oa_top_11 = sum(Market.Value.Rank < 12, na.rm=TRUE))
    colnames(key_players)[3:6] <- paste("key_players_", colnames(key_players)[3:6], sep="")
    
    merged <- Reduce(function(x, y) merge(x,y, all=TRUE), list(top_23, top_11, top_5_def, top_5_mid, top_5_att, top_gk, key_players))
    return(merged)
}

mw.data <- getMwStats()
datatable(mw.data)

```


```{r}
# fifa ranking
rank_years <- c(2002,2006,2010,2014,2018)
ranking.data <- fifa.ranking %>%
  select(rank, country_abrv, rank_date) %>%
  mutate(Year = format(rank_date, "%Y"), Month = format(rank_date, "%m")) %>%
  filter(Year %in% rank_years, Month < 6) %>%
  group_by(country_abrv, Year) %>%
  summarize(avg_rank = mean(rank, na.rm=TRUE),
            min_rank = min(rank, na.rm=TRUE),
            max_rank = max(rank, na.rm=TRUE))

datatable(ranking.data)

```


```{r}
# filter history to include results since 2000 as we don't care about earlier results (only vague relevance)
WC.matches <- Wc.matches %>% filter(Year >= 2000)
# TODO
```

* **Task 18** You do not have to use a statistical model, but if you do, you have to train it. This would require a trainings dataset. This training set would need include at least

- the result of the game
- general information about the game
- information about the home team
- information about the away team


* **Task 19** (voluntary) Create a list of pariticipating nations for every world cup and scrape their information from the follwing links:

[https://www.transfermarkt.de/weltmeisterschaft-2014/teilnehmer/pokalwettbewerb/WM14/saison_id/2013](https://www.transfermarkt.de/weltmeisterschaft-2014/teilnehmer/pokalwettbewerb/WM14/saison_id/2013)

[https://www.transfermarkt.de/weltmeisterschaft-2010/teilnehmer/pokalwettbewerb/WM10/saison_id/2009](https://www.transfermarkt.de/weltmeisterschaft-2010/teilnehmer/pokalwettbewerb/WM10/saison_id/2009)

[https://www.transfermarkt.de/weltmeisterschaft-2006/teilnehmer/pokalwettbewerb/WM06/saison_id/2005](https://www.transfermarkt.de/weltmeisterschaft-2006/teilnehmer/pokalwettbewerb/WM06/saison_id/2005)

[https://www.transfermarkt.de/weltmeisterschaft-2002/teilnehmer/pokalwettbewerb/WM02/saison_id/2001](https://www.transfermarkt.de/weltmeisterschaft-2002/teilnehmer/pokalwettbewerb/WM02/saison_id/2001)




